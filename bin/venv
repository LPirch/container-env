#!/bin/bash -e

export VENV_BASE_DIR="${VENV_BASE_DIR:-${HOME}/.venv}"
export VENV_USER_MNT="${VENV_USER_MNT:-/user}"

PROG="$0"
export VENV_NAME="$1"

# echo "VENV_BASE_DIR=\"${VENV_BASE_DIR}\"" >&2
# echo "VENV_NAME=\"${VENV_NAME}\"" >&2

if [ -z "${VENV_NAME}" ]; then
    echo "ERROR: Syntax: ${PROG} shell|program [...]" >&2
    exit 1
fi

shift 1
CMD="$1"

VENV_DIR="${VENV_BASE_DIR}/${VENV_NAME}"

if [ ! -d "${VENV_DIR}" ]; then
    echo "ERROR: venv directory \"${VENV_DIR}\" doesn't exist." >&2
    exit 1
fi

if [ -d "${VENV_DIR}/rootfs" ]; then
    FS_IMG="${VENV_DIR}/rootfs/"
elif [ -f "${VENV_DIR}/rootfs.sqsh" ]; then
    FS_IMG="${VENV_DIR}/rootfs.sqsh"
else
    echo "ERROR: No rootfs found in \"${VENV_DIR}\"." >&2
    exit 1
fi

if [ "${CMD}" = "shell" ]; then
    shift 1
elif [ -z "${CMD}" ]; then
    CMD="shell"
else
    CMD="exec"
fi


VENV_USER_DIR="${VENV_DIR}/user"
mkdir -p "${VENV_USER_DIR}"

if [ "${VENV_USER_MNT}" == "none" ] ; then
    VENV_USER_MNT="${VENV_USER_DIR}"
fi

# echo "DEBUG: VENV_DIR=\"${VENV_DIR}\"" >&2
# echo "DEBUG: VENV_USER_DIR=\"${VENV_USER_DIR}\"" >&2
# echo "DEBUG: VENV_USER_MNT=\"${VENV_USER_MNT}\"" >&2
# echo "DEBUG: FS_IMG=\"${FS_IMG}\"" >&2
# echo "DEBUG: CMD=\"${CMD} $@" >&2

export SWMOD_HOSTSPEC="linux-x86_64-${VENV_NAME}"
export SWMOD_INST_BASE="${VENV_USER_MNT}/.local/sw"
export SWMOD_MODPATH="${SWMOD_INST_BASE}"

export JUPYTER_CONFIG_DIR="${VENV_USER_MNT}/.jupyter"
export JUPYTER_DATA_DIR="${VENV_USER_MNT}/.local/share/jupyter"
export JULIA_PKGDIR="${VENV_USER_MNT}/.julia"
export ATOM_HOME="${VENV_USER_MNT}/.atom"

export VENV_NAME
export debian_chroot="${VENV_NAME}"


if [ "${VENV_USER_MNT}" != "${VENV_USER_DIR}" ] ; then
    exec singularity "${CMD}" \
        -B "${VENV_USER_DIR}:${VENV_USER_MNT}" \
        "${FS_IMG}" "$@"
else
    exec singularity "${CMD}" \
        "${FS_IMG}" "$@"
fi
